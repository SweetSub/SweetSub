# 自动更新章节标题和链接
# 该 Action 会检测所有有改动的目录，寻找其中的 xxx - **.chs.ass， ** 为两位数数字。
# ass 文件中单集标题行需要在说话人处用 ep_title 标注
# 该 ass 文件的同目录下需要有含有 <auto-generated-table> </auto-generated-table> 标记的 README.md 文件
# 该 Action 会自动更改 <auto-generated-table> </auto-generated-table> 中的表格

name: Auto-Generate-Table

on:
  push:
    branches: 
      - "master" 
    paths: 
      - "Archive/**.ass"

  workflow_dispatch:


jobs:
  Auto-Generate-Table:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed dirs
        id: detect
        shell: bash
        run: |
          set -euo pipefail
          before="${{ github.event.before }}"
          after="${{ github.sha }}"
          if [[ "$before" == "0000000000000000000000000000000000000000" ]]; then
            changed="$(git show --name-only --pretty='' "$after")"
          elif git cat-file -e "${before}^{commit}" 2>/dev/null; then
            changed="$(git diff --name-only "$before" "$after")"
          else
            echo "Before SHA not found locally; falling back to single commit diff."
            changed="$(git show --name-only --pretty='' "$after")"
          fi
          echo "Changed files:"
          echo "$changed"

          mapfile -t dirs < <(echo "$changed" | grep -E '^Archive/[^/]+/.+\\.ass$' | sed -E 's#^Archive/([^/]+)/.*#Archive/\\1#' | sort -u)
          if [ "${#dirs[@]}" -eq 0 ]; then
            echo "No Archive ass changes found."
            echo "skip=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          printf '%s\n' "${dirs[@]}" > dirs.txt
          echo "dir_file=dirs.txt" >> "$GITHUB_OUTPUT"

      - name: Run py script
        if: steps.detect.outputs.skip != 'true'
        shell: bash
        run: |
          set -euo pipefail
          while IFS= read -r dir; do
            files=()
            while IFS= read -r -d '' f; do
              files+=("$f")
            done < <(find "$dir" -maxdepth 1 -name '*.ass' -print0)
            if [ "${#files[@]}" -eq 0 ]; then
              echo "No ass files in ${dir}, skip."
              continue
            fi
            joined=$(printf '%s, ' "${files[@]}")
            joined=${joined%, }
            python .github/workflows/update_readme.py "$joined"
          done < "${{ steps.detect.outputs.dir_file }}"

      - name: Commit
        if: steps.detect.outputs.skip != 'true'
        shell: bash
        run: |
          set -euo pipefail
          git config user.email "85199982+SweetSub@users.noreply.github.com"
          git config user.name "SweetSub"
          git add "Archive"
          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi
          count=$(wc -l < "${{ steps.detect.outputs.dir_file }}" | tr -d ' ')
          git commit -m "Update README (${count} dirs)"
          git push origin master

          
